#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <IRremoteESP8266.h>
#include <IRsend.h>
#include <DHT.h>

const char* ssid = "Grayhouse";
const char* password = "pinturumah";
const char* getInfo = "http://192.168.1.10:5000/information";
const char* postTemperature = "http://192.168.1.10:5000/temperature";
String tempIndexOn = "0";
String tempIndexOff = "0";
uint16_t rawData[2][10][73] = {
  { { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 } },
  { { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 },
    { 4450, 4366, 484, 1722, 484, 1722, 486, 1724, 482, 630, 486, 630, 488, 630, 484, 632, 484, 632, 484, 1722, 486, 1724, 482, 1726, 480, 632, 486, 630, 482, 632, 486, 630, 486, 630, 486, 1724, 482, 1722, 486, 1722, 484, 1722, 484, 632, 484, 632, 484, 634, 482, 630, 486, 630, 484, 632, 484, 632, 484, 632, 484, 1724, 484, 1724, 482, 1724, 482, 1724, 504, 45452, 4480, 4334, 486, 630, 484 } }
};


HTTPClient http;
DHT dht(33, DHT11);
IRsend irsend(14);

void setupWifi() {
  delay(10);
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
}

void setup() {
  Serial.begin(115200);
  irsend.begin();
  dht.begin();
  setupWifi();
  pinMode(12, OUTPUT);
  pinMode(13, OUTPUT);
  pinMode(32, OUTPUT);
}

void led(String kode) {
  if (kode == "m") {
    digitalWrite(12, HIGH);
    digitalWrite(13, LOW);
    digitalWrite(32, LOW);
  } else if (kode == "k") {
    digitalWrite(12, LOW);
    digitalWrite(13, HIGH);
    digitalWrite(32, LOW);
  } else if (kode == "h") {
    digitalWrite(12, LOW);
    digitalWrite(13, LOW);
    digitalWrite(32, HIGH);
  }
}

void get() {
  http.begin(getInfo);
  http.GET();
  String datas = http.getString();
  DynamicJsonDocument doc(1024);
  deserializeJson(doc, datas);
  const char* index1 = doc["index1"];
  const char* index2 = doc["index2"];
  const char* kode = doc["kode"];
  if (String(index1) == "0") {
    if (tempIndexOff != String(index2)) {
      irsend.sendRaw(rawData[String(index1).toInt()][String(index2).toInt()], 73, 38);
      tempIndexOff == String(index2);
    }
  } else if (String(index1) == "1") {
    if (tempIndexOn != String(index2)) {
      irsend.sendRaw(rawData[String(index1).toInt()][String(index2).toInt()], 73, 38);
      tempIndexOn == String(index2);
    }
  }
  led(String(kode));
  http.end();
}

void post() {
  float t = dht.readTemperature();
  float h = dht.readHumidity();
  http.begin(postTemperature);
  http.addHeader("Content-Type", "application/json");
  String postTemp = "{\"temp\":\"" + String(t) "\"}";
  http.POST(postTemp);
  http.end();
}

void loop() {
  post();
  get();
  delay(1000);
}